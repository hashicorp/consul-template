name: ci

on:
  pull_request:
  push:
    branches:
      - main
      - release/**

env:
  CONSUL_LICENSE: ${{ secrets.CONSUL_LICENSE }}

jobs:
  run-tests:
    name: Test CT${{ matrix.ct-version }} + Consul${{ matrix.consul-ent-tag }} ${{ matrix.consul-version }}
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-latest]
        go: [^1]
        consul-ent-tag: ["", "-enterprise"]
        consul-version: ["1.18.15", "1.20.11", "1.21.5", "1.22.0"]
        ct-version: ["current", "0.40.0", "0.39.1"]
        exclude:
          # Don't test every combination - too many jobs
          # Only test current CT version with enterprise Consul
          - ct-version: "0.40.0"
            consul-ent-tag: "-enterprise"
          - ct-version: "0.39.1"
            consul-ent-tag: "-enterprise"

    steps:
      - uses: actions/checkout@692973e3d937129bcbf40652eb9f2f61becf3332 # v4.1.7

      - name: Set up Go
        uses: actions/setup-go@0a12ed9d6a96ab950c8f026ed9f722fe0da7ef32 # v5.0.2
        with:
          go-version: ${{ matrix.go }}
          cache: false

      - name: Setup HashiCorp apt repository
        run: |
          curl -fsSL https://apt.releases.hashicorp.com/gpg | sudo apt-key add -
          sudo apt-add-repository "deb [arch=amd64] https://apt.releases.hashicorp.com $(lsb_release -cs) main"
          sudo apt-get update

      - name: Install specific Consul version ${{ matrix.consul-version }}${{ matrix.consul-ent-tag }}
        run: |
          # Install specific Consul version via apt
          if [ "${{ matrix.consul-ent-tag }}" = "-enterprise" ]; then
            CONSUL_PACKAGE="consul=${{ matrix.consul-version }}+ent-1"
          else
            CONSUL_PACKAGE="consul=${{ matrix.consul-version }}-1"
          fi
          
          echo "Installing Consul package: $CONSUL_PACKAGE"
          sudo apt-get install -y "$CONSUL_PACKAGE"
          
          # Also install Vault and Nomad (latest versions are fine for testing)
          sudo apt-get install -y vault nomad

      - name: Setup consul-template version ${{ matrix.ct-version }}
        run: |
          if [ "${{ matrix.ct-version }}" = "current" ]; then
            # Build current version from source
            make dev
            echo "Using current consul-template version from source"
          else
            # Install specific released version via apt
            CT_PACKAGE="consul-template=${{ matrix.ct-version }}-1"
            echo "Installing consul-template package: $CT_PACKAGE"
            sudo apt-get install -y "$CT_PACKAGE"
          fi

      - name: Verify versions
        run: |
          consul version
          if [ "${{ matrix.ct-version }}" = "current" ]; then
            ./bin/consul-template -version
          else
            consul-template -version
          fi
          echo "Testing consul-template ${{ matrix.ct-version }} with Consul ${{ matrix.consul-version }}${{ matrix.consul-ent-tag }}"

      - name: Run integration tests with race detection
        run: |
          # Run the integration test suite with race detection
          # This tests consul-template functionality against the specific Consul version
          make test-race

      - name: Upload test results on failure
        if: failure()
        uses: actions/upload-artifact@ea165f8d65b6e75b540449e92b4886f43607fa02 # v4.6.2
        with:
          name: test-failure-ct${{ matrix.ct-version }}-consul${{ matrix.consul-version }}${{ matrix.consul-ent-tag }}
          path: |
            *.log
            test-results/
          retention-days: 7
